<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wvlet Syntax Highlighting Test</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
        }
        .code-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        pre {
            margin: 0;
            border-radius: 4px;
        }
        .theme-selector {
            margin-bottom: 20px;
        }
        .theme-selector select {
            padding: 8px;
            font-size: 14px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <h1>Wvlet Syntax Highlighting Demo</h1>
    
    <div class="theme-selector">
        <label for="theme">Theme: </label>
        <select id="theme" onchange="changeTheme(this.value)">
            <option value="github">GitHub</option>
            <option value="monokai">Monokai</option>
            <option value="dracula">Dracula</option>
            <option value="atom-one-dark">Atom One Dark</option>
            <option value="vs2015">VS 2015</option>
        </select>
    </div>

    <div class="code-container">
        <h2>Basic Query Example</h2>
        <pre><code class="language-wvlet">-- Define a model from JSON file
model person = {
  from 'person.json'
}

-- Query with filtering and aggregation
from person
where age >= 18 and status = 'active'
group by department
agg
  employee_count = count(*),
  avg_salary = avg(salary),
  max_age = max(age)
order by employee_count desc
limit 10</code></pre>
    </div>

    <div class="code-container">
        <h2>Complex Query with Joins</h2>
        <pre><code class="language-wvlet">--- 
Sales Analysis Query
@author Wvlet Team
---

-- Import required models
import 'models/sales.wv'

-- Define constants
val YEAR = 2024
val MIN_REVENUE = 1000.50

-- Main query with multiple joins
from orders
left join customers on orders.customer_id = customers.id
inner join products on orders.product_id = products.id
where 
  orders.order_date >= '2024-01-01' and
  orders.status in ('completed', 'shipped')
select
  order_id = orders.id,
  customer_name = customers.name,
  product_name = products.name,
  quantity = orders.quantity,
  unit_price = products.price,
  discount_pct = orders.discount * 100,
  total_amount = orders.quantity * products.price * (1 - orders.discount)
order by total_amount desc</code></pre>
    </div>

    <div class="code-container">
        <h2>Advanced Features</h2>
        <pre><code class="language-wvlet">-- Window functions
from sales
select
  product_id,
  sale_date,
  amount,
  running_total = sum(amount) over (
    partition by product_id 
    order by sale_date 
    rows between unbounded preceding and current row
  ),
  rank = row_number() over (
    partition by product_id 
    order by amount desc
  )

-- Pivot operation
from monthly_sales
pivot month
agg 
  revenue = sum(amount),
  transactions = count(*)

-- Case expressions
select
  customer_tier = case
    when total_purchases > 10000 then 'Gold'
    when total_purchases > 5000 then 'Silver'
    when total_purchases > 1000 then 'Bronze'
    else 'Regular'
  end

-- Test assertions
test _.size should be 100
test _.columns should contain ['user_id', 'name', 'email']
test _.output should be """
| id | status  |
|----|---------|
| 1  | active  |
| 2  | pending |
"""

-- Save results
save to 'output/results.parquet'</code></pre>
    </div>

    <div class="code-container">
        <h2>String Interpolation and Types</h2>
        <pre><code class="language-wvlet">-- Define a typed model
type User = {
  id: int,
  name: string,
  email: string,
  created_at: timestamp
}

def getUserById(userId: int) = {
  from users
  where id = ${userId}
  select *
}

-- Backquoted identifiers
select 
  `column with spaces`,
  `reserved-keyword`,
  `user-name` as userName

-- String interpolation
val tableName = "sales_2024"
val query = sql"""
  SELECT * FROM ${tableName}
  WHERE amount > ${MIN_AMOUNT}
"""

-- Lambda functions
from data
transform row => {
  id: row.id,
  fullName: row.firstName + " " + row.lastName,
  isActive: row.status == 'active'
}</code></pre>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/core.min.js"></script>
    <script type="module">
        // Import and define the Wvlet language inline
        const wvletLanguage = function(hljs) {
          const KEYWORDS = {
            keyword: 'model def type extends native inline val ' +
                     'from select where group by having order limit agg ' +
                     'join left right full inner cross asof on ' +
                     'pivot unpivot partition over rows range ' +
                     'add prepend exclude rename shift drop describe ' +
                     'concat dedup intersect except all distinct ' +
                     'save append delete truncate ' +
                     'import export package execute use run ' +
                     'test should be contain debug ' +
                     'show explain sample count ' +
                     'if then else case when end ' +
                     'and or not is like between exists in as with to for let this',
            literal: 'true false null',
            built_in: 'asc desc nulls first last of map'
          };

          const WVLET_IDENT = /[a-zA-Z_][a-zA-Z0-9_]*/;
          
          // Backquoted identifiers like `column_name`
          const BACKQUOTED_IDENT = {
            className: 'symbol',
            begin: /`/,
            end: /`/,
            contains: [
              {
                begin: /\\./  // escaped characters
              }
            ]
          };

          // String interpolation support
          const STRING_INTERPOLATION = {
            className: 'subst',
            begin: /\$\{/,
            end: /\}/,
            keywords: KEYWORDS,
            contains: [] // will be defined later
          };

          // Triple-quoted strings
          const TRIPLE_QUOTE_STRING = {
            className: 'string',
            begin: /"""/,
            end: /"""/,
            contains: [
              hljs.BACKSLASH_ESCAPE,
              STRING_INTERPOLATION
            ]
          };

          // Regular strings
          const STRING = {
            className: 'string',
            variants: [
              {
                begin: /"/,
                end: /"/,
                illegal: /\n/,
                contains: [
                  hljs.BACKSLASH_ESCAPE,
                  STRING_INTERPOLATION
                ]
              },
              {
                begin: /'/,
                end: /'/,
                illegal: /\n/,
                contains: [hljs.BACKSLASH_ESCAPE]
              }
            ]
          };

          // Comments
          const COMMENT = hljs.COMMENT(
            /--/,
            /$/,
            {
              relevance: 0
            }
          );

          // Doc comments (triple hyphen)
          const DOC_COMMENT = hljs.COMMENT(
            /---/,
            /---/,
            {
              relevance: 10,
              contains: [
                {
                  className: 'doctag',
                  begin: /@\w+/
                }
              ]
            }
          );

          // Numbers
          const NUMBER = {
            className: 'number',
            variants: [
              { begin: /\b\d+L\b/ },                    // Long literal
              { begin: /\b\d+\.\d+[fF]\b/ },           // Float literal  
              { begin: /\b\d+[fF]\b/ },                 // Float literal
              { begin: /\b\d+\.\d+([eE][+-]?\d+)?\b/ }, // Decimal/Double
              { begin: /\b\d+[eE][+-]?\d+\b/ },        // Exponential
              { begin: /\b\d+\b/ }                      // Integer
            ],
            relevance: 0
          };

          // Model/function definitions
          const MODEL_DEF = {
            className: 'function',
            beginKeywords: 'model def type',
            end: /[={]/,
            excludeEnd: true,
            contains: [
              {
                className: 'title',
                begin: WVLET_IDENT,
                relevance: 0
              },
              {
                className: 'params',
                begin: /\(/,
                end: /\)/,
                excludeBegin: true,
                excludeEnd: true,
                keywords: KEYWORDS,
                contains: [
                  STRING,
                  NUMBER,
                  hljs.C_LINE_COMMENT_MODE
                ]
              }
            ]
          };

          // Column references with dot notation
          const COLUMN_REF = {
            className: 'variable',
            begin: /\b[a-zA-Z_][a-zA-Z0-9_]*(\.[a-zA-Z_][a-zA-Z0-9_]*)*/,
            relevance: 0
          };

          // Operators
          const OPERATORS = {
            className: 'operator',
            begin: /[=!<>]=?|->|=>|<-|\+|-|\*|\/|\/\/|%|&|\||#/,
            relevance: 0
          };

          // Special underscore context
          const UNDERSCORE = {
            className: 'variable',
            begin: /\b_\b/,
            relevance: 0
          };

          // Test assertions
          const TEST_ASSERTION = {
            className: 'meta',
            begin: /^test\b/,
            end: /$/,
            keywords: 'test should be contain',
            contains: [
              STRING,
              NUMBER,
              COMMENT,
              COLUMN_REF
            ]
          };

          // From statements with file paths
          const FROM_STATEMENT = {
            begin: /\bfrom\s+'/,
            beginScope: {
              1: 'keyword'
            },
            end: /'/,
            contains: [
              {
                className: 'string',
                begin: /[^']+/
              }
            ]
          };

          // Define STRING_INTERPOLATION contents
          STRING_INTERPOLATION.contains = [
            STRING,
            NUMBER,
            COLUMN_REF,
            OPERATORS
          ];

          return {
            name: 'Wvlet',
            aliases: ['wv'],
            case_insensitive: false,
            keywords: KEYWORDS,
            contains: [
              DOC_COMMENT,
              COMMENT,
              TRIPLE_QUOTE_STRING,
              STRING,
              NUMBER,
              MODEL_DEF,
              TEST_ASSERTION,
              FROM_STATEMENT,
              BACKQUOTED_IDENT,
              UNDERSCORE,
              OPERATORS,
              COLUMN_REF,
              hljs.C_BLOCK_COMMENT_MODE
            ]
          };
        };
        
        // Register the language
        hljs.registerLanguage('wvlet', wvletLanguage);
        
        // Highlight all code blocks
        hljs.highlightAll();
        
        // Theme switcher
        window.changeTheme = function(theme) {
            const link = document.querySelector('link[rel="stylesheet"]');
            link.href = `https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/${theme}.min.css`;
        }
    </script>
</body>
</html>